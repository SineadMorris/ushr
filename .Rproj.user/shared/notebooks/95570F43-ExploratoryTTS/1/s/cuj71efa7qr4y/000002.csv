"0","biphasic_root <- function(timevec, params, suppression_threshold){"
"0","    value <- params[""A""] * exp (- timevec * params[""delta""]) + params[""B""] * exp( - timevec * params[""gamma""]) - suppression_threshold"
"0","    as.numeric(value)"
"0","}"
"0","get_parametricTTS <- function(params, rootfunction, suppression_threshold, uppertime){"
"0","    TTS <- rep(NA, nrow(params))"
"0","    for (i in 1:nrow(params)){"
"0","        TTS[i] = stats::uniroot(rootfunction, lower = 1, upper = uppertime,"
"0","                         params = params[i,], suppression_threshold = suppression_threshold)$root"
"0","    }"
"0","    return(TTS)"
"0","}"
"0","simulate_studies <- function(nsubjects, detection_threshold, simulation, mean_params){"
"0","    "
"0","    # 1. simulate data"
"0","    data0 <- simulate_data(nsubjects = nsubjects, detection_threshold = detection_threshold, "
"0","                           min_datapoints = 6, max_datapoints = 24, mean_params = mean_params) %>%"
"0","        mutate(type = ""intermediate"")"
"0","    data_fine <- simulate_data(nsubjects = nsubjects, detection_threshold = detection_threshold, "
"0","                              min_datapoints = 12, max_datapoints = 48, mean_params = mean_params) %>%"
"0","        mutate(type = ""high"")"
"0","    data_low <- simulate_data(nsubjects = nsubjects, detection_threshold = detection_threshold, "
"0","                             min_datapoints = 3, max_datapoints = 12, mean_params = mean_params) %>%"
"0","        mutate(type = ""low"")"
"0","    "
"0","    # 2. fit model"
"0","    model0 <- mash(data = data0, detection_threshold = detection_threshold)"
"0","    "
"0","    model_fine <- mash(data = data_fine, detection_threshold = detection_threshold)"
"0","    model_low <- mash(data = data_low, detection_threshold = detection_threshold)"
"0","    "
"0","    TTS0 <- get_TTS(model_output = model0, suppression_threshold = detection_threshold, parametric = TRUE) %>% "
"0","        filter(model == ""biphasic"") %>% select(id, TTS) %>% mutate(type = ""intermediate"")"
"0","    "
"0","    TTS_fine <- get_TTS(model_output = model_fine, suppression_threshold = detection_threshold, parametric = TRUE) %>% "
"0","        filter(model == ""biphasic"") %>% select(id, TTS) %>% mutate(type = ""high"")"
"0","        "
"0","    TTS_low <- get_TTS(model_output = model_low, suppression_threshold = detection_threshold, parametric = TRUE) %>% "
"0","        filter(model == ""biphasic"") %>% select(id, TTS) %>% mutate(type = ""low"")"
"0","    "
"0","    "
"0","    # 3. get biphasic CIs"
"0","    biphasicCI0 <- model0$biphasicCI %>% mutate(type = ""intermediate"")"
"0","    biphasic_fine <- model_fine$biphasicCI %>% mutate(type = ""high"")"
"0","    biphasic_low <- model_low$biphasicCI %>% mutate(type = ""low"")"
"0","        "
"0","    # 4. get true parameter values"
"0","    true <- data0 %>% filter(id %in% biphasicCI0$id) %>% "
"0","        distinct(id, A, delta, B, gamma, type) %>%"
"0","        mutate(TTS = get_parametricTTS(params = ., rootfunction = biphasic_root, "
"0","                                       suppression_threshold = detection_threshold, "
"0","                                       uppertime = 365),"
"0","               model = ""biphasic"", calculation = ""parametric"")"
"0","    "
"0","    true_fine <- data_fine %>% filter(id %in% biphasic_fine$id) %>% "
"0","        distinct(id, A, delta, B, gamma, type) %>%"
"0","        mutate(TTS = get_parametricTTS(params = ., rootfunction = biphasic_root, "
"0","                                       suppression_threshold = detection_threshold, "
"0","                                       uppertime = 365),"
"0","               model = ""biphasic"", calculation = ""parametric"")"
"0","      "
"0","    true_low <-  data_low %>% filter(id %in% biphasic_low$id) %>% "
"0","        distinct(id, A, delta, B, gamma, type) %>%"
"0","        mutate(TTS = get_parametricTTS(params = ., rootfunction = biphasic_root, "
"0","                                       suppression_threshold = detection_threshold, "
"0","                                       uppertime = 365),"
"0","               model = ""biphasic"", calculation = ""parametric"")"
"0","    "
"0","    # 5. collect results"
"0","    data_all <- rbind(data0, data_fine, data_low) %>% "
"0","        mutate(simulation = simulation)"
"0","        "
"0","    true_all <- rbind(true, true_fine, true_low) %>% "
"0","        mutate(shortlifespan = 1/delta, longlifespan = 1/gamma,"
"0","               logA = log10(A), logB = log10(B)) %>%"
"0","        gather(param, true, A:gamma, shortlifespan:logB, TTS) %>% "
"0","        mutate(simulation = simulation)"
"0","    "
"0","    TTS_all <- rbind(TTS0, TTS_fine, TTS_low)"
"0","    "
"0","    biphasic_all <- rbind(biphasicCI0, biphasic_fine, biphasic_low) %>% "
"0","        mutate(simulation = simulation) %>% distinct(id, param, estimate, type, simulation) %>% "
"0","        spread(param, estimate) %>%"
"0","        mutate(shortlifespan = 1/delta, longlifespan = 1/gamma, "
"0","               logA = log10(A), logB = log10(B)) %>%"
"0","        left_join(TTS_all) %>%"
"0","         # mutate(TTS = get_parametricTTS(params = ., rootfunction = biphasic_root, "
"0","         #                               suppression_threshold = detection_threshold, "
"0","         #                               uppertime = 365),"
"0","         #       model = ""biphasic"", calculation = ""parametric"") %>%"
"0","        gather(param, estimate, A:logB, TTS)"
"0","    "
"0","    # 6. get deviation scores"
"0","    stats <- biphasic_all  %>%"
"0","        left_join(true_all) %>% "
"0","        group_by(type, param) %>% mutate(n = n()) %>%"
"0","        mutate(deviation = (true - estimate)/true) %>%"
"0","        summarize(deviation = sum(deviation)/unique(n)) %>% ungroup() %>%"
"0","        arrange(desc(abs(deviation))) %>% mutate(simulation = simulation)"
"0","    "
"0","    return(list(data = data_all, true_all = true_all, "
"0","                biphasic_all = biphasic_all, stats = stats))"
"0","}"
